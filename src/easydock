#!/usr/bin/env bash

# +-------------------------------------------------------------------------+
# | EasyDock-Linux is a Docker LEMP easy integration for Debian/Ubuntu      |
# |-------------------------------------------------------------------------+
# | Package URI       : https://masedi.net/easydock-linux                   |
# | Authors           : Edi Septriyanto <me@masedi.net>                     |
# |                     Andrea Pollastri <andrea@pollastri.dev>             |
# | Min. requirement  : GNU/Linux Debian 8, Ubuntu 16.04 or Linux Mint 17   |
# | Version           : 1.0.0                                               |
# | Last Update       : 08/03/2021                                          |
# +-------------------------------------------------------------------------+
# | EasyDock-Linux Copyright (c) 2021 MasEDI.Net                            |
# | EasyDock's Logo & Name Copyright (c) Andrea Pollastri                   |
# +-------------------------------------------------------------------------+
# | This source file is subject to the GNU General Public License           |
# | that is bundled with this package in the file LICENSE.md.               |
# |                                                                         |
# | If you did not receive a copy of the license and are unable to          |
# | obtain it through the world-wide-web, please send an email              |
# | to license@masedi.net so we can send you a copy immediately.            |
# +-------------------------------------------------------------------------+

# Work even if somebody does "bash easydock".
set -e

# EasyDock command (for pretify the instruction message).
ED_CMD="bash easydock"

# Sudo required commands.
SUDO_CMDS="reset"

# EasyDock CLI source directory.
SOURCE="${BASH_SOURCE[0]}"
HOMEPATH=${HOME}

# If the current source is a symbolic link, we need to resolve it to an
# actual directory name. We'll use PHP to do this easier than we can
# do it in pure Bash. So, we'll call into PHP CLI here to resolve.
if [[ -L ${SOURCE} ]]; then
    ED_DIR=$(php -r "echo dirname(realpath('${SOURCE}'));")
else
    ED_DIR="$( cd "$( dirname "${SOURCE}" )" && pwd )"
fi

# If we are in the global Composer "bin" directory, we need to bump our
# current directory up two, so that we will correctly proxy into the
# EasyDock src which is written in bash. Will use PHP to do it.
if [[ ! -f "${ED_DIR}/src/.easydock" ]]; then
    ED_DIR=$(php -r "echo realpath('${ED_DIR}/../');")
    ED_CMD="easydock"
fi

# Application absolute directory path.
APP_DIR=$(pwd)

############################################################ COMMON VARS
menu=$1
action=$2
reset=$(tput sgr0)
br="\n"
bold=$(tput bold)
underline=$(tput smul)
black=$(tput setaf 0)
white=$(tput setaf 7)
red=$(tput setaf 1)
green=$(tput setaf 2)
yellow=$(tput setaf 3)
blue=$(tput setaf 4)
purple=$(tput setaf 5)
bgblack=$(tput setab 0)
bgwhite=$(tput setab 7)
bgred=$(tput setab 1)
bggreen=$(tput setab 2)
bgyellow=$(tput setab 3)
bgblue=$(tput setab 4)
bgpurple=$(tput setab 5)

############################################################ LOGO

function ed_logo() {
    echo "${blue}${bold}"
    echo "******************************************************"
    echo "                           _            _      __   "
    echo "   ___  __ _ ___ _   _  __| | ___   ___| | __  \ \  "
    echo "  / _ \/ _' / __| | | |/ _' |/ _ \ / __| |/ / (_) | "
    echo " |  __/ (_| \__ \ |_| | (_| | (_) | (__|   <   _| | "
    echo "  \___|\__,_|___/\__, |\__,_|\___/ \___|_|\_\ ( ) | "
    echo "                 |___/                        |/_/  "
    echo ""
    echo "******************************************************"
    echo -e "${reset}"
}

############################################################ DEPENDENCIES CHECK

function ed_check_dependencies() {
    local PCKGS=''

    for cmd in "certutil" "docker" "docker-compose"; do
        local str=''

        if ! [[ -x "$(command -v ${cmd})" ]]; then
            printf -v str " - %s\n" "${cmd}"
            local PCKGS+="${str}"
        fi
    done

    if [[ ${PCKGS} != '' ]]; then
        echo -e "${bgwhite}${red}${bold} >>> ERROR! ${reset} To run easydock you have to install the required packages :${br}"
        echo "${PCKGS}"
        echo -e "Please refer to https://github.com/joglomedia/easydock-linux/wiki/${reset}${br}"
        exit 1
    fi
}

# If the command is one of the commands that requires "sudo" privileges
# then we'll proxy the incoming CLI request using sudo, which allows
# us to never require the end users to manually specify each sudo.
function ed_requires_sudo() {
    local CMD=$1

    if [[ -n ${CMD} && ${SUDO_CMDS} =~ ${CMD} ]]; then
        if [[ "${EUID}" -ne 0 ]]; then
            sudo env HOME=${HOMEPATH} ${SOURCE} "$@"
            exit 0
        fi
    fi
}

############################################################ INIT ENV CONFIG

function ed_init() {
    clear
    ed_logo
    echo -e "${blue}Wait...${reset}${br}"

    if [ -f ./.env.easydock ]; then
        echo -e "${bgyellow}${black}${bold} >>> WARNING! ${reset} an .env.easydock file is located in your workspace. ${br}Delete it if you want to regenerate it within this command. ${reset}${br}"
    else
        # Copy easydock default env config.
        cp "${ED_DIR}/src/.env.easydock" ./.env.easydock
        sed -i -e 's/APP_SID=easydock/APP_SID=easydock'$(((RANDOM%1000000000)+1))'/g' ./.env.easydock
        # Update application directory path.
        sed -i "s|APP_DIR=\"./\"|APP_DIR=\"${APP_DIR}\"|g" ./.env.easydock
        # Update easydock directory path.
        sed -i "s|ED_DIR=\"./vendor/joglomedia/easydock-linux\"|ED_DIR=\"${ED_DIR}\"|g" ./.env.easydock

        # Create .easydock directory to store application data (such as MySQL database, LEMP config, etc).
        mkdir ./.easydock
        cp -fr "${ED_DIR}/config" ./.easydock/
        cp -fr "${ED_DIR}/data" ./.easydock/
        cp "${ED_DIR}/src/Dockerfile" ./.easydock/
        cp "${ED_DIR}/src/docker-compose.yml" ./.easydock/

        echo -e "${bgpurple}${white} Your ${bold}.env.easydock${reset}${bgpurple}${white} has been created ${br}${reset}"
    fi
}

# An alias for ed_init.
function ed_env() {
    ed_init
}

############################################################ VENDOR EXPORT

function ed_import() {
    echo -e "${bgyellow}${black}${bold} >>> WARNING! ${reset} This command will overwrite existing config data.${br}"
    read -r -p "Are you sure to export easydock config? (Y/n): " -n 1 -r

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${br}${br}${blue}Wait...${reset}${br}"

        [ -f ./.env.easydock ] && unlink ./.env.easydock
        cp "${ED_DIR}/src/.env.easydock" ./.env.easydock

        [ -f ./easydock ] && unlink ./easydock
        #cp "${ED_DIR}/src/easydock" ./easydock

        [ -d ./.easydock ] && rm -fr ./.easydock
        mkdir ./.easydock
        cp -fr "${ED_DIR}/config" ./.easydock/
        cp -fr "${ED_DIR}/data" ./.easydock/
        cp "${ED_DIR}/src/Dockerfile" ./.easydock/
        cp "${ED_DIR}/src/docker-compose.yml" ./.easydock/

        # Generate random easydock's app id.
        sed -i 's/APP_SID=easydock/APP_SID=easydock'$(((RANDOM%1000000000)+1))'/g' ./.env.easydock
        # Update application directory path.
        sed -i "s|APP_DIR=\"./\"|APP_DIR=\"${APP_DIR}\"|g" ./.env.easydock
        # Update easydock directory path.
        sed -i "s|ED_DIR=\"./vendor/joglomedia/easydock-linux\"|ED_DIR=\"${ED_DIR}\"|g" ./.env.easydock
        #[ -f ./.env.easydock-e ] && unlink ./.env.easydock-e

        echo -e "${bgpurple}${white} easydock is ready! All you have to do is compile your ${bold}.env.easydock${reset}${bgpurple}${white} file and run ${bold}${ED_CMD} setup${reset}${bgpurple}${white} ${br}${reset}"
    else
        echo -e "${br}${br}${bgpurple}${white} easydock command cancelled! ${reset}"
    fi
}

############################################################ COMMON FUNCTIONS

function ed_notfound() {
    command="$1"
    clear
    ed_logo
    echo -e "${bgwhite}${red}${bold} >>> ERROR! ${reset} Command ${bgred}${white}${bold} ${ED_CMD} $command ${reset} is not a valid option. ${br}${br}Run ${bgred}${white}${bold} ${ED_CMD} help ${reset} to obtain a list of valid options. ${reset}${br}"
}

function ed_isthisportfree() {
    port="$1"
    check=$(lsof -i "tcp:${port}")
    if [ -z "$check" ]; then
        return 0
    else
        return 1
    fi
}

function ed_unavailableport() {
    port=$1
    echo -e "${bgwhite}${red}${bold} >>> ERROR! ${reset} Port: ${bgred}${white}${bold} $port ${reset} is used. Try another port. ${reset}${br}"
    exit
}

function ed_availableport() {
    port=$1
    echo "${green}$port is available!${reset}"
}

function ed_checkingport() {
    port=$1
    echo -e "${br}${blue}Checking port $port...${reset}"
}

function ed_portscheck() {
    ed_checkingport "${ed_portapp}"
    if ed_isthisportfree "${ed_portapp}"; then
        ed_availableport "${ed_portapp}"
    else
        ed_unavailableport "${ed_portapp}"
    fi
    ed_checkingport "${ed_portdb}"
    if ed_isthisportfree "${ed_portdb}"; then
        ed_availableport "${ed_portdb}"
    else
        ed_unavailableport "${ed_portdb}"
    fi
    ed_checkingport "${ed_portpma}"
    if ed_isthisportfree "${ed_portpma}"; then
        ed_availableport "${ed_portpma}"
    else
        ed_unavailableport "${ed_portpma}"
    fi
    ed_checkingport "${ed_portmh}"
    if ed_isthisportfree "${ed_portmh}"; then
        ed_availableport "${ed_portmh}"
    else
        ed_unavailableport "${ed_portmh}"
    fi
    ed_checkingport "${ed_portrds}"
    if ed_isthisportfree "${ed_portrds}"; then
        ed_availableport "${ed_portrds}"
    else
        ed_unavailableport "${ed_portrds}"
    fi
}

############################################################ CLI FUNCTIONS

function ed_help() {
    echo -e "${bgpurple}${white}${bold} easydock Options List ${reset}${br}${br}"
    echo "${bgwhite}${black} ${ED_CMD} init ${reset}"
    echo -e "Initialize easydock system for the first time.${br}"
    echo "${bgwhite}${black} ${ED_CMD} import ${reset}"
    echo -e "Import default easydock configuration (overwrite existing files).${br}"
    echo "${bgwhite}${black} ${ED_CMD} setup ${reset}"
    echo -e "Bootstrap easydock system (build docker app container).${br}"
    echo "${bgwhite}${black} ${ED_CMD} up ${reset}"
    echo -e "Start easydock system.${br}"
    echo "${bgwhite}${black} ${ED_CMD} down ${reset}"
    echo -e "Stop easydock system.${br}"
    echo "${bgwhite}${black} ${ED_CMD} shell ${reset}"
    echo -e "SSH shell access into easydock system.${br}"
    echo "${bgwhite}${black} ${ED_CMD} reset ${reset}"
    echo -e "Reset easydock system.${br}"
    echo "${bgwhite}${black} ${ED_CMD} info ${reset}"
    echo -e "Get easydock configuration information.${br}"
}

function ed_info() {
    echo -e "${bgpurple}${white}${bold} easydock System Information ${reset}${br}"
    echo "NAME: ${ed_appsid}"
    echo "PATH: ${ed_appsrc}"
    echo "DOCUMENT ROOT: /var/www/public"
    echo "CATCH ALL FILE: index.php"
    if [ "${ed_portapp}" == "80" ]; then
        echo "HOST: http://localhost"
    else
        echo "HOST: http://localhost:${ed_portapp}"
    fi
    echo -e "STACK: nginx / php:${ed_phpver} / mariadb ${br}"
    echo "${bold}MYSQL${reset}"
    echo "HOST: mysql:3306 (int) / 127.0.0.1:${ed_portdb} (ext)"
    echo "NAME: ${ed_dbname}"
    echo "USER: root"
    echo -e "PASS: ${ed_dbpass} ${br}"
    echo "${bold}SMTP${reset}"
    echo "HOST: mailhog"
    echo "PORT: 1025"
    echo "USER: ${underline}not required${reset}"
    echo -e "PASS: ${underline}not required${reset}${br}"
    echo "${bold}SERVICE${reset}"
    echo "phpmyadmin                 http://localhost:${ed_portpma}"
    echo -e "Mail Hog                   http://localhost:${ed_portmh} ${br}"
}

function ed_reset() {
    echo -e "${bgyellow}${black}${bold} >>> WARNING! ${reset} This command will reset container and database.${br}"
    read -r -p "Are you sure to reset easydock? (Y/n): " -n 1 -r

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${br}${br}${blue}Wait...${reset}${br}"
        docker-compose -f ./.easydock/docker-compose.yml --env-file=./.env.easydock down -v
        docker-compose -f ./.easydock/docker-compose.yml --env-file=./.env.easydock rm
        rm -fr ./.easydock/data/*
        cp "${ED_DIR}/src/.gitignore.dist" ./.easydock/data/.gitignore
        echo -e "${br}${bgpurple}${white} easydock has been reset! ${reset}"
    else
        echo -e "${br}${br}${bgpurple}${white} easydock command cancelled! ${reset}"
    fi
}

function ed_up() {
    echo -e "${blue}Wait...${reset}${br}"
    docker-compose -f ./.easydock/docker-compose.yml --env-file=./.env.easydock down
    echo -e "${br}${bgblue}${white} Checking required ports ${reset}"
    ed_portscheck
    echo -e "${br}${bgblue}${white} Create and start easydock containers ${reset}${br}"
    docker-compose -f ./.easydock/docker-compose.yml --env-file=./.env.easydock up -d --force-recreate

    if [ "${ed_portapp}" == "80" ]; then
        echo -e "${br}${bgpurple}${white} easydock has been started... visit ${bold}${underline}http://localhost${reset}${bgpurple}${white} ${reset}${br}"
    else
        echo -e "${br}${bgpurple}${white} easydock has been started... visit ${bold}${underline}http://localhost:${ed_portapp}${reset}${bgpurple}${white} ${reset}${br}"
    fi
}

function ed_down() {
    read -r -p "Are you sure to stop and remove containers from easydock system? (Y/n): " -n 1 -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${br}${br}${blue}Wait...${reset}${br}"
        docker-compose -f ./.easydock/docker-compose.yml --env-file=./.env.easydock down
        echo -e "${br}${bgpurple}${white} easydock has been stopped and containers removed! ${reset}"
    else
        echo -e ${br}
    fi
}

function ed_start() {
    echo -e "${blue}Wait...${reset}${br}"
    echo -e "${bgblue}${white} Checking required ports ${reset}"
    ed_portscheck
    echo -e "${br}${bgblue}${white} Starting easydock containers ${reset}${br}"
    docker-compose -f ./.easydock/docker-compose.yml --env-file=./.env.easydock start

    if [ "${ed_portapp}" == "80" ]; then
        echo -e "${br}${bgpurple}${white} easydock app has been started... visit ${bold}${underline}http://localhost${reset}${bgpurple}${white} ${reset}${br}"
    else
        echo -e "${br}${bgpurple}${white} easydock app has been started... visit ${bold}${underline}http://localhost:${ed_portapp}${reset}${bgpurple}${white} ${reset}${br}"
    fi
}

function ed_stop() {
    read -r -p "Are you sure to stop easydock system? (Y/n): " -n 1 -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${br}${br}${blue}Wait...${reset}${br}"
        docker-compose -f ./.easydock/docker-compose.yml --env-file=./.env.easydock stop
        echo -e "${br}${bgpurple}${white} easydock app has been stopped! ${reset}"
    else
        echo -e ${br}
    fi
}

function ed_ps() {
    echo -e "${blue}Wait... ${reset}${br}"
    sleep 1s
    echo -e "${bgblue}${white} Easydock running containers ${reset}${br}"
    docker-compose -f ./.easydock/docker-compose.yml --env-file=./.env.easydock ps
}

function ed_shell() {
    echo -e "${blue}Wait... ${reset}${br}"
    sleep 1s
    echo -e "${bgblue}${white} Container CLI ${reset}${br}${br}"
    echo -e "Run ${bgwhite}${black} exit ${reset} to return on your device CLI.${br}"
    docker-compose -f ./.easydock/docker-compose.yml --env-file=./.env.easydock exec app /bin/bash
}

function ed_conn() {
    ed_shell
}

function ed_setup() {
    echo -e "${blue}Wait... ${reset}${br}"
    echo -e "${bgblue}${white} Checking required ports ${reset}"
    ed_portscheck
    echo -e "${br}${bgblue}${white} Pulling Docker images ${reset}${br}"
    docker-compose -f ./.easydock/docker-compose.yml --env-file=./.env.easydock build --no-cache --pull
    sleep 1s    
    clear
    ed_logo
    echo "${bgpurple}${white} easydock is ready! Run ${bgwhite}${black} ${ED_CMD} up ${reset}"
}

############################################################ CLI MENU

function ed_cli_menu() {
    while [ -n "${menu}" ]; do
        case ${menu} in
        help)
            shift
            ed_help
            exit
            ;;
        info)
            shift
            ed_info
            exit
            ;;
        import)
            shift
            ed_import
            exit
            ;;
        setup)
            shift
            ed_setup
            exit
            ;;
        reset)
            shift
            ed_reset "${action}"
            exit
            ;;
        up)
            shift
            ed_up
            exit
            ;;
        down)
            shift
            ed_down
            exit
            ;;
        start)
            shift
            ed_start
            exit
            ;;
        stop)
            shift
            ed_stop
            exit
            ;;
        ps)
            shift
            ed_ps
            exit
            ;;
        conn)
            shift
            ed_conn
            exit
            ;;
        shell)
            shift
            ed_shell
            exit
            ;;
        *)
            shift
            ed_notfound "${menu}"
            exit -1
            ;;
        esac
        shift
    done
}

############################################################ EASYDOCK CLI INIT

function ed_bootstrap() {
    # Check ed command which requires sudo.
    ed_requires_sudo "$@"

    # Export env config.
    if [ "${menu}" == "init" ]; then
        # Check dependencies when ed initialized.
        ed_check_dependencies
        ed_init
        exit
    fi

    # Main easydock commands.
    if [ -f ./.env.easydock ]; then
        clear
        ed_logo

        ed_portapp=$(grep APP_PORT .env.easydock | cut -d '=' -f2)
        ed_portdb=$(grep DB_PORT .env.easydock | cut -d '=' -f2)
        ed_portpma=$(grep PMA_PORT .env.easydock | cut -d '=' -f2)
        ed_portmh=$(grep MH_PORT .env.easydock | cut -d '=' -f2)
        ed_portrds=$(grep RDS_PORT .env.easydock | cut -d '=' -f2)
        ed_appsid=$(grep APP_SID .env.easydock | cut -d '=' -f2)
        ed_appsrc=$(grep APP_SRC .env.easydock | cut -d '=' -f2)
        ed_phpver=$(grep PHP_V .env.easydock | cut -d '=' -f2)
        ed_dbver=$(grep DB_VERS .env.easydock | cut -d '=' -f2)
        ed_dbname=$(grep DB_NAME .env.easydock | cut -d '=' -f2)
        ed_dbpass=$(grep DB_PASS .env.easydock | cut -d '=' -f2)
        ed_nginx=$(grep NGINX_MODE .env.easydock | cut -d '=' -f2)

        # Execute CLI command.
        ed_cli_menu "$@"
    else
        clear
        ed_logo
        echo -e "${bgwhite}${red}${bold} >>> ERROR! ${reset} File ${bgred}${white}${bold} .env.easydock ${reset} is missing. Run ${bgred}${white}${bold} ${ED_CMD} init ${reset} to generate it. ${reset}${br}"
        exit
    fi
}

ed_bootstrap "$@"